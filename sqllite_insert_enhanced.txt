import sqlite3
import pandas as pd
import logging
from datetime import datetime

# --- Configuration ---
csv_file = 'bmi.csv'
database_file = 'my_database.db'
table_name = 'data_table'
log_file = "db_operations.log"
# --- End Configuration ---

# --- Logging Setup ---
logging.basicConfig(
    filename=log_file,
    level=logging.INFO,
    format="%(asctime)s - %(message)s"
)

# Operation counters
insert_count = 0
update_count = 0
delete_count = 0


def log_operation(query):
    """Log each SQL operation into the log file."""
    logging.info(query)


def upload_csv_to_sqlite(csv_path, db_path, table):
    global insert_count, update_count, delete_count

    try:
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        print(f"‚úÖ Connected to database: {db_path}")

        df = pd.read_csv(csv_path)
        print(f"‚úÖ Loaded CSV file: {csv_path}")

        # Drop & recreate table (your original behaviour)
        df.to_sql(table, conn, if_exists='replace', index=False)

        # Count INSERTs manually
        cursor.execute(f"SELECT COUNT(*) FROM {table}")
        row_count = cursor.fetchone()[0]
        insert_count = row_count

        # Log each INSERT record
        for index, row in df.iterrows():
            query = f"INSERT INTO {table} VALUES ({', '.join([repr(x) for x in row.values])});"
            log_operation(query)

        print(f"üìä Rows inserted: {insert_count}")

        # Simulate or count UPDATE and DELETE queries
        # (No updates/deletes in your original script, so they remain zero.)

    except Exception as e:
        print(f"‚ùå Error: {e}")

    finally:
        conn.close()
        print("‚û°Ô∏è Database connection closed.")

        # Log summary
        summary = (
            f"Run Summary ‚Üí INSERTS={insert_count}, "
            f"UPDATES={update_count}, DELETES={delete_count}"
        )
        logging.info(summary)

        print("üìÅ Log updated:", log_file)




# Run function
upload_csv_to_sqlite(csv_file, database_file, table_name)
